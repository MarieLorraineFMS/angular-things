<div class="row mb-5">
  <div class="col-md-10 mx-auto">
    <mat-card class="p-4 shadow-sm border-0 bg-light">
      <div class="row g-4 align-items-center">
        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Rechercher...</mat-label>
            <input
              matInput
              [ngModel]="searchTerm()"
              (ngModelChange)="searchTerm.set($event)"
              placeholder="Ex: Chakra, Andúril..."
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Catégorie</mat-label>
            <mat-select
              [ngModel]="selectedCategory()"
              (ngModelChange)="selectedCategory.set($event)"
            >
              <mat-option value="Toutes">Toutes</mat-option>
              @for (c of catService.list(); track c.id) {
                <mat-option [value]="c.name">{{ c.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <label class="small text-muted mb-2 d-block">
            Budget : {{ lowestPrice() }}€ - {{ maxPrice() }}€
          </label>
          <mat-slider [min]="lowestPrice()" [max]="highestPrice()" step="1" class="w-100">
            <input matSliderThumb [ngModel]="maxPrice()" (ngModelChange)="maxPrice.set($event)" />
          </mat-slider>
        </div>
      </div>
    </mat-card>
  </div>
</div>

<div class="row">
  @for (t of filteredTrainings(); track t.id) {
    <div class="col-md-4 mb-4">
      <mat-card class="h-100 shadow border-0 training-card">
        <div
          class="card-header-icon d-flex justify-content-center align-items-center py-4 bg-light"
        >
          @if (t.icon) {
            @if (t.icon.startsWith('bi-')) {
              <i [class]="'bi ' + t.icon" class="icon-render"></i>
            } @else if (t.icon.startsWith('fa-')) {
              <i [class]="'fa-solid ' + t.icon" class="icon-render"></i>
            } @else {
              <mat-icon class="icon-render">{{ t.icon }}</mat-icon>
            }
          } @else {
            <mat-icon class="icon-render fallback-star">{{ t.icon }}</mat-icon>
          }
        </div>

        <mat-card-content class="text-center pt-3 d-flex flex-column flex-grow-1">
          <mat-card-title class="text-primary fw-bold mb-2">{{ t.name }}</mat-card-title>

          @if (authService.currentUser() && !authService.isAdmin()) {
            <button mat-icon-button color="warn" (click)="toggleFavorite(t)" class="fav-btn">
              <mat-icon>{{ isFavorite(t) ? 'favorite' : 'favorite_border' }}</mat-icon>
            </button>
          }

          <p class="text-muted small flex-grow-1 px-2">{{ t.description }}</p>

          <div class="price-badge mt-3">
            <span class="h4 text-danger fw-bold">{{ t.price | currency: 'EUR' }}</span>
          </div>
        </mat-card-content>

        @if (authService.currentUser() && !authService.isAdmin()) {
          <mat-card-actions class="pb-3 px-3">
            <button matFab extended color="primary" class="w-100 py-2" (click)="addToCart(t)">
              <mat-icon>add_shopping_cart</mat-icon> Ajouter au panier
            </button>
          </mat-card-actions>
        }
      </mat-card>
    </div>
  } @empty {
    <div class="text-center py-5">
      <mat-icon class="display-1 text-muted">search_off</mat-icon>
      <h3 class="text-muted mt-3">Aucune formation trouvée pour "{{ searchTerm() }}"</h3>
      <button matFab extended color="primary" (click)="searchTerm.set('')">
        Effacer la recherche
      </button>
    </div>
  }
</div>
