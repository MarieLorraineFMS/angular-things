<div class="container py-5">
  <div class="d-flex align-items-center mb-4">
    <mat-icon class="me-2 text-primary fs-1" style="width: auto; height: auto"
      >shopping_basket</mat-icon
    >
    <h2 class="mb-0 fw-bold">Votre Inventaire</h2>
  </div>

  <div class="row g-4">
    <div [class]="showOrderForm() ? 'col-lg-7' : 'col-lg-12'">
      <mat-card class="shadow-sm border-0 overflow-hidden">
        <div class="p-3 bg-light border-bottom">
          <mat-form-field appearance="outline" class="w-100 hide-subscript">
            <mat-label>Chercher...</mat-label>
            <input matInput [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <mat-card-content class="p-0">
          <div class="table-responsive">
            <table class="table align-middle mb-0 custom-table">
              <thead class="bg-light text-muted small text-uppercase">
                <tr>
                  <th class="ps-4">Formation</th>
                  <th class="text-center">Quantité</th>
                  <th class="text-end">Sous-total</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody>
                @for (item of filteredItems(); track item.id; let i = $index) {
                  <tr class="cart-row">
                    <td class="ps-4 py-3">
                      <div class="fw-bold text-primary">{{ item.name }}</div>
                      <span class="badge rounded-pill bg-light text-dark border small">{{
                        item.category
                      }}</span>
                    </td>
                    <td class="text-center">
                      <div class="quantity-control d-inline-flex align-items-center shadow-sm">
                        <button mat-icon-button (click)="cartService.updateQuantity(item.id, -1)">
                          <mat-icon>remove</mat-icon>
                        </button>
                        <span class="mx-2 fw-bold">{{ item.quantity || 1 }}</span>
                        <button mat-icon-button (click)="cartService.updateQuantity(item.id, 1)">
                          <mat-icon>add</mat-icon>
                        </button>
                      </div>
                    </td>
                    <td class="text-end fw-bold text-primary px-3">
                      {{ item.price * (item.quantity || 1) | currency: 'EUR' }}
                    </td>
                    <td class="text-center">
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="cartService.removeFromCart(i)"
                        title="Supprimer"
                        class="delete-btn"
                      >
                        <mat-icon>delete_outline</mat-icon>
                      </button>
                    </td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="4" class="text-center py-5">
                      <mat-icon class="display-1 text-muted opacity-25">shopping_cart_off</mat-icon>
                      <p class="text-muted mt-3">Votre sac est vide...</p>
                      <button mat-flat-button color="primary" routerLink="/trainings">
                        Retourner au catalogue
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </mat-card-content>

        @if (items().length > 0) {
          <mat-card-footer
            class="p-4 bg-light border-top d-flex justify-content-between align-items-center"
          >
            <div class="text-muted">Total de la transaction :</div>
            <div class="h3 mb-0 fw-bold text-danger">
              {{ cartService.totalAmount() | currency: 'EUR' }}
            </div>
          </mat-card-footer>
        }
      </mat-card>

      @if (items().length > 0 && !showOrderForm()) {
        <div class="d-flex justify-content-between mt-4">
          <button mat-button routerLink="/trainings">← Continuer mes achats</button>
          <div>
            <button mat-stroked-button color="warn" class="me-2" (click)="cartService.clearCart()">
              Vider le sac
            </button>
            <button filled mat-raised-button color="primary" (click)="showOrderForm.set(true)">
              Passer à la caisse
            </button>
          </div>
        </div>
      }
    </div>

    @if (showOrderForm()) {
      <div class="col-lg-5">
        <mat-card class="shadow border-primary-top">
          <mat-card-header class="bg-primary text-white p-3 rounded-top">
            <mat-card-title>Commande</mat-card-title>
          </mat-card-header>
          <mat-card-content class="pt-4 px-4 pb-2">
            <form #orderForm="ngForm" (ngSubmit)="onOrder()" class="custom-form">
              <mat-form-field appearance="fill" class="w-100 mb-2">
                <mat-label>Votre Nom</mat-label>
                <input matInput name="name" [(ngModel)]="customer.fullName" required />
                <mat-icon matPrefix class="me-2">person</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="fill" class="w-100 mb-2">
                <mat-label>Email</mat-label>
                <input
                  matInput
                  type="email"
                  name="email"
                  [(ngModel)]="customer.email"
                  required
                  email
                />
                <mat-icon matPrefix class="me-2">alternate_email</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="fill" class="w-100 mb-2">
                <mat-label>Adresse de votre demeure</mat-label>
                <textarea
                  matInput
                  name="address"
                  [(ngModel)]="customer.address"
                  required
                  rows="3"
                ></textarea>
                <mat-icon matPrefix class="me-2">home</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="fill" class="w-100 mb-3">
                <mat-label>Le zéro six</mat-label>
                <input matInput type="tel" name="phone" [(ngModel)]="customer.phone" required />
                <mat-icon matPrefix class="me-2">phone</mat-icon>
              </mat-form-field>

              <button
                mat-flat-button
                color="primary"
                type="submit"
                [disabled]="orderForm.invalid"
                class="w-100 py-3 fs-5 mb-2"
              >
                Valider ({{ cartService.totalAmount() }} €)
              </button>

              <button
                mat-button
                type="button"
                (click)="showOrderForm.set(false)"
                class="w-100 text-muted"
              >
                Modifier mon sac
              </button>
            </form>
          </mat-card-content>
        </mat-card>
      </div>
    }
  </div>
</div>
